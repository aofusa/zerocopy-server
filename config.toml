# ==========================================
# High-Performance Reverse Proxy Server
# 設定ファイル
# ==========================================

[server]
listen = "0.0.0.0:443"

# ワーカースレッド数（オプション）
# 未指定または0の場合はCPUコア数と同じスレッド数を使用
threads = 4


# ==========================================
# グローバルセキュリティ設定
# ==========================================
[security]

# 権限降格設定（Linux専用）
# rootで起動した場合、リスナー作成後に指定ユーザー/グループへ降格
# 
# 注意: 特権ポート（1024未満）を使用する場合は、以下のいずれかが必要:
#   1. CAP_NET_BIND_SERVICEケイパビリティを付与:
#      sudo setcap 'cap_net_bind_service=+ep' ./target/release/zerocopy-server
#   2. または非特権ポート（1024以上）を使用
#
# drop_privileges_user = "nobody"
# drop_privileges_group = "nogroup"

# グローバル同時接続上限（0 = 無制限）
# max_concurrent_connections = 10000


# ==========================================
# パフォーマンス設定
# ==========================================
[performance]

# SO_REUSEPORT の振り分け方式
# "kernel" = カーネルデフォルト（3元タプルハッシュ）
# "cbpf"   = クライアントIPベースのCBPF（キャッシュ効率向上、Linux 4.6+必須）
reuseport_balancing = "cbpf"

# Huge Pages (Large OS Pages) の使用
# true: mimallocでHuge Pages（2MB）を優先使用し、TLBミスを削減
# false: 通常の4KBページを使用
#
# 利点:
#   - TLB（Translation Lookaside Buffer）ミス削減
#   - 大容量メモリ使用時（バッファプール拡大）のページフォルト減少
#   - kTLS/splice時のカーネル連携で効果的（5-10%パフォーマンス向上）
#
# 要件（Linux）:
#   sudo echo 128 > /proc/sys/vm/nr_hugepages
#   または /etc/sysctl.conf に vm.nr_hugepages=128 を追加
#
# 注意:
#   - コンテナ環境（Docker/K8s）では無効化される可能性あり
#   - 利用不可の場合は自動的に通常ページにフォールバック
huge_pages_enabled = true


# ==========================================
# TLS設定
# ==========================================
[tls]

cert_path = "/path/to/cert.pem"
key_path = "/path/to/key.pem"

# kTLS有効化（Linux 5.15+、feature flag必須）
ktls_enabled = false

# kTLS有効化失敗時にrustlsへフォールバックするかどうか
# false: kTLS必須（失敗時は接続拒否）
# true: kTLS失敗時はrustlsで継続（デフォルト）
ktls_fallback_enabled = false


# ==========================================
# ホストベースのルーティング定義
# ==========================================
# ホスト名が完全一致した場合のデフォルトバックエンド
# 注意: path_routesより先に評価されるため、ホスト全体のデフォルトとして使用
#
# ルートごとのセキュリティ設定（security）オプション:
#
#   サイズ制限:
#     max_request_body_size         リクエストボディ最大サイズ（バイト）     デフォルト: 10MB
#     max_chunked_body_size         Chunked転送時の累積最大サイズ（バイト） デフォルト: 10MB
#     max_request_header_size       リクエストヘッダー最大サイズ（バイト）   デフォルト: 8KB
#
#   タイムアウト:
#     client_header_timeout_secs    クライアントヘッダー受信タイムアウト     デフォルト: 30秒
#     client_body_timeout_secs      クライアントボディ受信タイムアウト       デフォルト: 30秒
#     backend_connect_timeout_secs  バックエンド接続タイムアウト             デフォルト: 10秒
#
#   アクセス制御:
#     allowed_methods               許可するHTTPメソッド（配列）             デフォルト: すべて許可
#     rate_limit_requests_per_min   分間リクエスト数上限                     デフォルト: 0（無制限）
#     allowed_ips                   許可するIP/CIDR（配列）                  デフォルト: すべて許可
#     denied_ips                    拒否するIP/CIDR（配列、denyが優先）      デフォルト: なし
#
#   IP制限の評価順序: deny → allow（denyが優先）
#     例: allowed_ips = ["192.168.0.0/16"], denied_ips = ["192.168.1.100"]
#         → 192.168.1.100 は拒否、それ以外の 192.168.x.x は許可
#
#   コネクションプール:
#     max_idle_connections_per_host ホストごとの最大アイドル接続数           デフォルト: 8
#     idle_connection_timeout_secs  アイドル接続の維持時間                   デフォルト: 30秒

[host_routes."example.com"]
type = "File"
path = "/var/www/example"
mode = "sendfile"

[host_routes."api.example.com"]
type = "Proxy"
url = "http://localhost:8080"


# ==========================================
# パスベースのルーティング定義 (Nginx風)
# ==========================================
# 優先順位: 最長プレフィックス一致 (PathRouterの実装により自動解決)
#
# ルーティングの挙動:
# 
# 1. 静的ファイル（完全一致）
#    パスが末尾スラッシュなし & 設定pathがファイル → 完全一致
#    例: "/robots.txt" → リクエスト "/robots.txt" にのみマッチ
#
# 2. ディレクトリ配信（Alias動作）
#    設定pathがディレクトリ → プレフィックス除去後の残りパスをディレクトリに結合
#    例: "/static/" + path="/var/www/assets/"
#        リクエスト "/static/css/style.css" → "/var/www/assets/css/style.css"
#
# 3. インデックスファイル
#    index オプションでディレクトリアクセス時に返すファイルを指定
#    未指定の場合はデフォルトで "index.html" を使用
#
# 4. プロキシ（Proxy Pass動作）
#    プレフィックス除去後の残りパスをバックエンドURLに結合
#    例: "/api/" + url="http://backend:3000/app/"
#        リクエスト "/api/v1/users" → "http://backend:3000/app/v1/users"


# ------------------------------------------
# 静的ファイル（完全一致）
# ------------------------------------------
# リクエスト: /robots.txt → /var/www/robots.txt を返す
# リクエスト: /robots.txt/hoge → 404 Not Found
[path_routes."example.com"."/robots.txt"]
type = "File"
path = "/var/www/robots.txt"

# ------------------------------------------
# 静的ディレクトリ配信
# ------------------------------------------

# デフォルトインデックス (index.html)
[path_routes."example.com"."/static/"]
type = "File"
path = "/var/www/assets/"
mode = "sendfile"

# カスタムインデックス (profile.html)
[path_routes."example.com"."/user/"]
type = "File"
path = "/var/www/user/"
index = "profile.html"

# カスタムインデックス (dashboard.html)
[path_routes."example.com"."/app/"]
type = "File"
path = "/var/www/app/"
index = "dashboard.html"

# 末尾スラッシュなし（301リダイレクトなし）
[path_routes."example.com"."/docs"]
type = "File"
path = "/var/www/docs/"

# ------------------------------------------
# プロキシ配信
# ------------------------------------------

# シンプルなプロキシ
[path_routes."example.com"."/backend"]
type = "Proxy"
url = "http://localhost:3000"

# セキュリティ設定付きプロキシ
# - 許可メソッド: GET, POST, PUT のみ
# - ボディサイズ制限: 5MB
# - バックエンド接続タイムアウト: 5秒
# - レートリミット: 60リクエスト/分
[path_routes."example.com"."/api/"]
type = "Proxy"
url = "http://localhost:8080/app/"

  [path_routes."example.com"."/api/".security]
  allowed_methods = ["GET", "POST", "PUT"]
  max_request_body_size = 5_242_880
  backend_connect_timeout_secs = 5
  rate_limit_requests_per_min = 60

# ------------------------------------------
# 管理用API（IP制限付き）
# ------------------------------------------
# 内部ネットワークからのみアクセス許可
# - 許可: 192.168.0.0/16, 10.0.0.0/8, 127.0.0.1
# - 拒否: 192.168.1.100（特定のホストを除外）
[path_routes."example.com"."/admin/"]
type = "Proxy"
url = "http://localhost:9000/"

  [path_routes."example.com"."/admin/".security]
  allowed_ips = [
    "192.168.0.0/16",
    "10.0.0.0/8",
    "127.0.0.1"
  ]
  denied_ips = ["192.168.1.100"]
  allowed_methods = ["GET", "POST"]

# ------------------------------------------
# ルートパス
# ------------------------------------------
# "/" は完全一致（/へのリクエストのみマッチ）
# catch-all動作はなし: マッチしないパスは404
[path_routes."example.com"."/"]
type = "File"
path = "/var/www/index.html"

  [path_routes."example.com"."/".security]
  allowed_methods = ["GET"]
